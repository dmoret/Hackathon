<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, target-densitydpi=device-dpi" />
        
        <meta name="msapplication-tap-highlight" content="no" />
        <script src="http://localhost:5000/target/target-script-min.js#anonymous"></script>
        <title>Tee Buddy</title>
        <link rel="stylesheet" type="text/css" href="css/framework7.css" />
        <link href="css/app.css" rel="stylesheet" type="text/css" />
        <link href="css/ionicons.min.css" rel="stylesheet" type="text/css" />
        <script type="text/javascript" language="javascript" src="js/moment.js"></script>
    </head>
    <body class="theme-red">
 

<!-- Statusbar overlay-->
    <div class="statusbar-overlay"></div>
    <!-- Views-->
    <div class="views">
      <div class="view view-main navbar-fixed">
        <div class="navbar">
          <div class="navbar-inner">
            <div class="left"></div>
            <div class="center sliding">Golf Courses</div>
            <div class="right"><a href="#" class="link icon-only open-popup"><i class="icon icon-plus">+</i></a></div>
          </div>
        </div>
        <div class="pages">
          <div data-page="index" class="page">
            <div class="page-content">
              <div class="list-block facilities-list theme-green"></div>
            </div>
          </div>
        </div>
                <div class="toolbar tabbar tabbar-labels">
            <div class="toolbar-inner">
                <a href="index.html" class="tab-link active">
                    <i class="icon ion-flag"></i>
                    <span class="tabbar-label i18n" data-i18n="index.contacts">Courses</span>
                </a>

                <a href="settings.html" class="tab-link">
                    <i class="icon ion-ios-gear">
                        <!-- <span class="badge badge-red">4</span> -->
                    </i>
                    <span class="tabbar-label i18n" data-i18n="index.setting">Settings</span>
                </a>
            </div>
        </div>
      </div>
    </div>
    <!-- Popup to add new task           -->
    <div class="popup">
      <div class="view view-popup navbar-fixed">
        <div class="navbar">
          <div class="navbar-inner">
            <div class="left"></div>
            <div class="center sliding">New Task</div>
            <div class="right"><a href="#" class="link close-popup">Cancel</a></div>
          </div>
        </div>
        <div class="pages">
          <div class="page">
            <div class="page-content">

              <div class="list-block">
                <ul>
                  <li>
                    <div class="item-content">
                      <div class="item-inner"> 
                        <div class="item-title label">Task</div>
                        <div class="item-input">
                          <input type="text" name="title">
                        </div>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="item-content">
                      <div class="item-inner"> 
                        <div class="item-title label">Color</div>
                        <div class="item-input"><span data-color="orange" class="color selected"></span><span data-color="green" class="color"></span><span data-color="blue" class="color"></span><span data-color="yellow" class="color"></span><span data-color="white" class="color"></span><span data-color="pink" class="color"></span><span data-color="purple" class="color"></span><span data-color="cyan" class="color"></span></div>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="content-block"><a class="button add-task">Add Task</a></div>
            </div>
          </div>
        </div>
      </div>
    </div>

<!-- Template: index -->
<script id="facilities-template" type="text/template">
    <div class="list-block">
    <ul>{{#each this}}
    <li><a href="tee-times.html?id={{ID}}" class="item-link">
    <div class="item-content">
        <div class="item-media">
            <img src="http://{{ThumbnailImagePath}}" alt="{{Name}}" width=44 />
        </div>
        <div class="item-inner">
            <div class="item-title-row">
                <div class="item-title">{{Name}}<br /><div class="item-subtitle">Tee Times Available {{teeTimeCount}}</div></div>
            </div>
            
        </div>
    </div></a></li>{{/each}}
    </ul>
    </div>
</script>
<!-- Template: facility-->
<script id="facility-template" type="text/template">
     <div class="facility-image">
        <img src="http://{{ThumbnailImagePath}}">
    </div>
    <div class="facility-info">
        <h3>{{Name}}</h3>
        {{Description}}
    </div>
    <div class="facility-links">
        <a href="{{WebsiteAddress}}" target="_blank" class="external-link">Website</a> | 
        <a id="directions" href="http://maps.google.com?daddr={{AddressString}}/@{{Latitude}},{{Longitude}},16Z" target="_blank" class="external-link">Get Directions</a>
    </div>
</script>

<!-- Template: tee-times -->
<script id="tee-times-template" type="text/template">
    <div class="list-block">
        <div class="list-group">
            <h3>Tee Times Ending Soon!</h3>
            <ul>{{#each this}}
                <li>
                    <a href="{{DisplayRate.TeeTimeRateID}}" class="popup-purchase item-link item-content external">
                        <div class="item-media"><i class="icon ion-ios-clock-outline"></i></div>
                        <div class="item-inner">
                            <div class="item-title datetime">{{Time}}</div>
                        </div>
                    </a>
                </li>{{/each}}
            </ul>
            <p>&nbsp;</p>
        </div>
    </div>
</script>

<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/framework7.js"></script>
<script type="text/javascript">
        
// Initialize your app
var myApp = new Framework7({
    modalTitle: 'Tee-Buddy',
    template7Pages: true, //enable Template7 rendering for pages
    /*
     template7Data: {
        // This context will applied for page/template with "about.html" URL
        'url:tee-times.html': {
            name: 'Test',
            desc: 'this is a desc',
            img: ''
        }
    }
 */
});

// Export selectors engine
var $$ = Dom7;

// Add views
var mainView = myApp.addView('.view-main', {
    // Because we use fixed-through navbar we can enable dynamic navbar
    dynamicNavbar: true
});

var todoData = localStorage.td7Data ? JSON.parse(localStorage.td7Data) : [];






$$('.popup').on('open', function () {
    $$('body').addClass('with-popup');
});
$$('.popup').on('opened', function () {
    $$(this).find('input[name="title"]').focus();
});
$$('.popup').on('close', function () {
    $$('body').removeClass('with-popup');
    $$(this).find('input[name="title"]').blur().val('');
});

// Popup colors
$$('.popup .color').on('click', function () {
    $$('.popup .color.selected').removeClass('selected');
    $$(this).addClass('selected');
});


// Add Task
$$('.popup .add-task').on('click', function () {
    var title = $$('.popup input[name="title"]').val().trim();
    if (title.length === 0) {
        return;
    }
    var color = $$('.popup .color.selected').attr('data-color');
    todoData.push({
        title: title,
        color: color,
        checked: '',
        id: (new Date()).getTime()
    });
    localStorage.td7Data = JSON.stringify(todoData);
    buildTodoListHtml();
    myApp.closeModal('.popup');

});

// Mark checked
$$('.facilities-list').on('change', 'input', function () {
    var input = $$(this);
    var item = input.parents('li');
    var checked = input[0].checked;
    var id = item.attr('data-id') * 1;
    for (var i = 0; i < todoData.length; i++) {
        if (todoData[i].id === id) todoData[i].checked = checked ? 'checked' : '';
    }
    localStorage.td7Data = JSON.stringify(todoData);
});

// Delete item
$$('.facilities-list').on('delete', '.swipeout', function () {
    var id = $$(this).attr('data-id') * 1;
    var index;
    for (var i = 0; i < todoData.length; i++) {
        if (todoData[i].id === id) index = i;
    }
    if (typeof(index) !== 'undefined') {
        todoData.splice(index, 1);
        localStorage.td7Data = JSON.stringify(todoData);
    }
});

// Update app when manifest updated 
// http://www.html5rocks.com/en/tutorials/appcache/beginner/
// Check if a new cache is available on page load.
window.addEventListener('load', function (e) {
    window.applicationCache.addEventListener('updateready', function (e) {
        if (window.applicationCache.status === window.applicationCache.UPDATEREADY) {
            // Browser downloaded a new app cache.
            myApp.confirm('A new version of ToDo7 is available. Do you want to load it right now?', function () {
                window.location.reload();
            });
        } else {
            // Manifest didn't changed. Nothing new to server.
        }
    }, false);
}, false);

var facilities = {};

var facility = {};

var teeTimesData = {}

myApp.onPageInit('tee-times', function (page) {
  
    var id = page.query.id;

    console.log('facility ID ',page);

    for(key in facilities){
        //get facility clicked
        if(id == facilities[key].ID){
            facility = facilities[key];
    
            console.log('you clicked this facility',facility);
             //console.log('PAGE TEMPLATE DATA:');
            // console.log(myApp.template7Data['url:tee-times.html']);
             teeTimesData = facility.Ratesets.Value;
             console.log('teeTimesData:',teeTimesData);

             /*
             myApp.template7Data['url:tee-times.html'].name = facility.Name;
             myApp.template7Data['url:tee-times.html'].desc = facility.Description;
             myApp.template7Data['url:tee-times.html'].img = facility.ThumbnailImagePath;
            */
            /*
            mainView.router.load({
                url: 'tee-times.html',
                context: {
                  name: facility.Name,
                  desc: facility.Description,
                  img: facility.ThumbnailImagePath
                }
            });
*/
            var facilityTemplateSource = $$('#facility-template').html();
            var teeTimesTemplateSource = $$('#tee-times-template').html();

            var facilityTemplate = Template7.compile(facilityTemplateSource);
            var teeTimesTemplate = Template7.compile(teeTimesTemplateSource);

            var facilityInfo = facilityTemplate(facility);
            var teeTimesList = teeTimesTemplate(teeTimesData);

            console.log('teeTimesList',teeTimesList);
            $$('.facility-info').html(facilityInfo);
            $$('.tee-times').html(teeTimesList);

            

            //track views with azure cloud
            apiRequest(
                'http://catz.cloudapp.net:4000/api/course?name='+facility.Name,
                {},
                'GET',
                function(result){
                    console.log('tracker result',result);
                }
            );


            
            
            break;
        }
    }
    // "page" variable contains all required information about loaded and initialized page 
$$('.external-link').on('click',function(){
    console.log('asdasdas');
    
    var targetURL = $$(this).attr('href');
    console.log('targetURL',targetURL);
    //window.open(targetURL,'_system');
    var ref = window.open(encodeURI(targetURL), '_blank','location=yes');
    
});
$$('.tee-times .datetime').each(function(index,value){

    var tee_datetime = $$(this).html();
    //moment(tee_datetime).fromNow(); 
    var a = moment(tee_datetime);
    var b = moment();
    /*
    console.log('a',a);
    console.log('b',b);
    console.log('Expires in '+a.diff(b, 'hours')); // 1
    */
    $$(this).html(a.format('MMMM D,YYYY hh:mm a')+'<br/> <em class="small">Expires in '+a.diff(b, 'hours')+' hour(s)</em>');

});


$$('.popup-purchase').on('click', function () {

        var _self = this;

        //var purchase_id = $$.data(_self,'purchase-id');
        var purchase_id = $$(_self).attr('href');
        console.log('purchase id', purchase_id);

        for(key in teeTimesData){
            
            if(purchase_id == teeTimesData[key].DisplayRate.TeeTimeRateID){
                
                var due_online = teeTimesData[key].DisplayRate.SinglePlayerPrice.DueOnline;
                var display_price = due_online.Value+' '+due_online.CurrencyCode;
                console.log('teeTimesData ',teeTimesData[key]);
                var tee_time = moment(teeTimesData[key].Time).format('MMMM D,YYYY hh:mm a');

                var popupHTML = 
                '<div class="popup">'+
                '<div class="content-block">'+
                    '<div class="row">'+
                        '<!-- Each "cell" has col-[widht in percents] class -->'+
                        //'<form id="form-purchase">'+
                        '<div align="left" class="col-50">'+
                            '<h3 style="margin-top:0;">'+facility.Name+'</h3>'+
                            '<h4>'+tee_time+'</h4>'+
                            '<select name="players">'+
                                '<option value="1">1 player</option>'+
                                '<option value="2">2 players</option>'+
                                '<option value="3">3 players</option>'+
                                '<option value="4" selected="selected">4 players</option>'+
                            '</select>'+
                        '</div>'+
                        '<div align="right" class="col-50">'+
                            '<h3 style="margin:0;">$'+display_price+'</h3>'+
                            '<p>per player</p>'+
                            '<a href="#" class="button button-big active">Add to Cart</a>'+
                        '</div>'+
                        //'</form>'+
                    '</div> '+
                    '<p></p>'+
                    //'<p class="buttons-row">'+
                        '<a href="#" class="button button-big close-popup">Close</a>'+
                    //'</p>'+
                    //'<p><a href="#" class="close-popup">Close me</a></p>'+
                '</div>'+
                '</div>'
                myApp.popup(popupHTML);

                
                console.log('tee time: ',tee_time);

                apiRequest('http://catz.cloudapp.net:4000/api/tee?name='+tee_time,
                {},
                'GET',
                function(result){
                    console.log('tracker result',result);
                })

                break;
            } 


        }
       
    });  

});
 
//facilities in area by geo - template
var facilitiesTemplateSource = $$('#facilities-template').html();
var facilitiesTemplate = Template7.compile(facilitiesTemplateSource);

var api = {
    user:'Hackathon_Development',
    pass:'6YBkHF86ut7946pDwZhp'
}

var apiRequest = function(url,params,requestType,callback){
        

        var _self = this;
        
        //url = 'https://sandbox.api.gnsvc.com/rest/'+url;
        //params = (undefined === params) ? {} : params;
        //requestType = (undefined === requestType) ? 'POST' : requestType;
        
        var headers = {
            'UserName': api.user,
            'Password': api.pass,
            'Accept-Encoding': 'gzip, deflate',
        }

        $$.ajax({
            url: url,
            headers: headers,
            method: requestType,
            dataType: 'json',
            success: function(response){
                console.log('test response:');
                //console.log(response);

                callback(response);
            },
            error: function(jqXHR){
                console.log('error:');
                console.log(jqXHR);
                callback(false);
            }
        });
        

    }


    var getTeeTimesByGeo = function(){
        
        var lat = '34.0204989';
        var long = '-118.4117325';
        var proximity = '10';
        
        var url = 'https://sandbox.api.gnsvc.com/rest/channel/11329/facilities?q=geo-location&latitude='+lat+'&longitude='+long+'&proximity='+proximity+'&expand=FacilityDetail.Ratesets';
    

        apiRequest(url,{},'GET',function(data){

            facilities = data;
            /*
            for(key in facilities){
                var facility_id = facilities[key].ID;

                console.log('facility id: ' + facility_id);

                var url = 'channel/11329/facilities/'+facility_id+'/reviews?take=1&skip=0';

                 apiRequest(url,{},'GET',function(review){
                    
                   
                   facilities[key].review = review;

                   console.log('facility review:');
                   console.log(facilities[key].review);

                    console.log('facilities')
                    console.log(facilities);

                    var renderedList = todoItemTemplate(facilities);
                    $$('.todo-items-list').html(renderedList);

                });
            }
            */


            for(key in facilities){
               
                facilities[key].teeTimeCount = facilities[key].Ratesets.Value.length;

                //set address into string for directions
                facilities[key].AddressString = facilities[key].Address.Line1;

                if(facilities[key].Address.Line2 != '')
                    facilities[key].AddressString += '+'+facilities[key].Address.Line2;

                facilities[key].AddressString += '+'+facilities[key].Address.City+'+'
                +facilities[key].Address.StateProvinceCode+'+'
                +facilities[key].Address.PostalCode+'+'
                +facilities[key].Address.Country;
                
                facilities[key].AddressString = facilities[key].AddressString.replace(' ','+');
            }
        

            console.log('facilities')
            console.log(facilities);

            var facilitiesList = facilitiesTemplate(facilities);
            $$('.facilities-list').html(facilitiesList);
            
        });




    }

    getTeeTimesByGeo();
</script>
    </body>
</html>